<UserControl x:Class="C_TestForge.UI.Controls.FunctionsAnalysisControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    
    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <materialDesign:Card Grid.Row="0" Margin="0,0,0,12" UniformCornerRadius="8"
                           materialDesign:ShadowAssist.ShadowDepth="Depth1">
            <Grid Margin="20,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Function" 
                                           Foreground="{StaticResource AccentColor}" 
                                           VerticalAlignment="Center" Margin="0,0,12,0" Width="24" Height="24"/>
                    <StackPanel>
                        <TextBlock Text="Functions Analysis" Style="{StaticResource HeadingStyle}" Margin="0,0,0,4"/>
                        <TextBlock Text="{Binding Functions.Count, StringFormat='Total: {0} functions found'}" 
                                 Style="{StaticResource SubheadingStyle}"/>
                    </StackPanel>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="Export Functions" Style="{StaticResource OutlinedButtonStyle}"
                          Command="{Binding ExportFunctionsCommand}" 
                          Margin="0,0,8,0">
                        <Button.ContentTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="FileTableOutline" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding}"/>
                                </StackPanel>
                            </DataTemplate>
                        </Button.ContentTemplate>
                    </Button>
                    <Button Content="Analyze Relationships" Style="{StaticResource PrimaryButtonStyle}"
                          Command="{Binding AnalyzeFunctionRelationshipsCommand}">
                        <Button.ContentTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="GraphOutline" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding}"/>
                                </StackPanel>
                            </DataTemplate>
                        </Button.ContentTemplate>
                    </Button>
                </StackPanel>
            </Grid>
        </materialDesign:Card>
        
        <!-- Filters and Actions -->
        <materialDesign:Card Grid.Row="1" Margin="0,0,0,12" UniformCornerRadius="8"
                           materialDesign:ShadowAssist.ShadowDepth="Depth1">
            <Grid Margin="16,12">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Search and Filter Row -->
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBox Grid.Column="0" 
                           Style="{StaticResource MaterialDesignOutlinedTextBox}"
                           materialDesign:HintAssist.Hint="Search functions by name, return type, or signature..."
                           Text="{Binding FunctionSearchText, UpdateSourceTrigger=PropertyChanged}"
                           Margin="0,0,12,0"/>
                    
                    <ComboBox Grid.Column="1" Width="150"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Return Type"
                            ItemsSource="{Binding AvailableReturnTypes}"
                            SelectedItem="{Binding SelectedReturnTypeFilter}"
                            Margin="0,0,12,0"/>
                    
                    <ComboBox Grid.Column="2" Width="120"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Parameter Count"
                            ItemsSource="{Binding ParameterCountOptions}"
                            SelectedItem="{Binding SelectedParameterCountFilter}"
                            Margin="0,0,12,0"/>
                    
                    <Button Grid.Column="3" Content="Advanced Search" 
                          Style="{StaticResource SecondaryButtonStyle}"
                          Command="{Binding ShowAdvancedSearchCommand}"/>
                </Grid>
                
                <!-- Toggle Filters Row -->
                <StackPanel Grid.Row="1" Orientation="Horizontal">
                    <ToggleButton Content="Static Only" 
                                Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                                IsChecked="{Binding ShowStaticOnly}"
                                Margin="0,0,8,0" Padding="8,4"/>
                    
                    <ToggleButton Content="Inline Only" 
                                Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                                IsChecked="{Binding ShowInlineOnly}"
                                Margin="0,0,8,0" Padding="8,4"/>
                    
                    <ToggleButton Content="With Parameters" 
                                Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                                IsChecked="{Binding ShowWithParametersOnly}"
                                Margin="0,0,8,0" Padding="8,4"/>
                    
                    <ToggleButton Content="Show Body Preview" 
                                Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                                IsChecked="{Binding ShowFunctionBody}"
                                Margin="0,0,8,0" Padding="8,4"/>
                    
                    <Button Content="Clear All" 
                          Style="{StaticResource TextButtonStyle}"
                          Command="{Binding ClearFunctionFiltersCommand}"/>
                </StackPanel>
            </Grid>
        </materialDesign:Card>
        
        <!-- Functions DataGrid -->
        <materialDesign:Card Grid.Row="2" UniformCornerRadius="8"
                           materialDesign:ShadowAssist.ShadowDepth="Depth1">
            <DataGrid ItemsSource="{Binding FilteredFunctions}" 
                    Style="{StaticResource ModernDataGridStyle}"
                    materialDesign:DataGridAssist.ColumnHeaderPadding="8,4" 
                    Margin="8" CanUserAddRows="False" CanUserDeleteRows="False"
                    SelectedItem="{Binding SelectedFunction}"
                    RowHeight="{Binding ShowFunctionBody, Converter={StaticResource BoolToRowHeightConverter}}">
                <DataGrid.Columns>
                    <!-- Function Name with Visibility Icon -->
                    <DataGridTemplateColumn Header="Function" Width="220" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal">
                                        <materialDesign:PackIcon Kind="{Binding IsStatic, Converter={StaticResource BoolToIconConverter}, ConverterParameter='LockOutline,Function'}" 
                                                               Width="16" Height="16" Margin="0,0,6,0" VerticalAlignment="Center"
                                                               Foreground="{Binding IsStatic, Converter={StaticResource BoolToColorConverter}}"/>
                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center" FontWeight="Medium"/>
                                        <Border Background="{StaticResource InfoColor}" CornerRadius="8" Padding="4,2" Margin="4,0,0,0"
                                              Visibility="{Binding IsInline, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <TextBlock Text="inline" Foreground="White" FontSize="9"/>
                                        </Border>
                                    </StackPanel>
                                    
                                    <!-- Function Body Preview (if enabled) -->
                                    <TextBlock Text="{Binding Body}" 
                                             FontFamily="{StaticResource CodeFont}" FontSize="11"
                                             Foreground="{StaticResource SecondaryText}"
                                             TextTrimming="CharacterEllipsis" MaxHeight="60"
                                             TextWrapping="Wrap" Margin="22,4,0,0"
                                             Visibility="{Binding DataContext.ShowFunctionBody, RelativeSource={RelativeSource AncestorType=DataGrid}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Return Type -->
                    <DataGridTemplateColumn Header="Return Type" Width="120" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border Background="{Binding ReturnType, Converter={StaticResource TypeToColorConverter}}" 
                                      CornerRadius="12" Padding="6,2" HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding ReturnType}" 
                                             Foreground="White" FontSize="11" FontWeight="Medium"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Parameters Info -->
                    <DataGridTemplateColumn Header="Parameters" Width="100" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <materialDesign:PackIcon Kind="FormatListNumbered" Width="14" Height="14" 
                                                           VerticalAlignment="Center" Margin="0,0,4,0"/>
                                    <TextBlock Text="{Binding Parameters.Count}" VerticalAlignment="Center" FontWeight="Medium"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Signature -->
                    <DataGridTemplateColumn Header="Signature" Width="*" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Signature}" 
                                         FontFamily="{StaticResource CodeFont}" FontSize="12"
                                         TextTrimming="CharacterEllipsis"
                                         ToolTip="{Binding Signature}"
                                         VerticalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Location Info -->
                    <DataGridTemplateColumn Header="Location" Width="100" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <TextBlock Text="{Binding StartLineNumber, StringFormat='L{0}'}" 
                                             FontFamily="{StaticResource CodeFont}" FontSize="11"
                                             HorizontalAlignment="Center"/>
                                    <TextBlock Text="{Binding EndLineNumber, StringFormat='To {0}'}" 
                                             FontFamily="{StaticResource CodeFont}" FontSize="10"
                                             Foreground="{StaticResource SecondaryText}"
                                             HorizontalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Source File -->
                    <DataGridTextColumn Header="Source File" Binding="{Binding SourceFile}" Width="150"
                                      materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                <Setter Property="ToolTip" Value="{Binding SourceFile}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    
                    <!-- Actions -->
                    <DataGridTemplateColumn Header="Actions" Width="120" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <Button Style="{StaticResource MaterialDesignIconButton}" 
                                          ToolTip="Analyze Function"
                                          Command="{Binding DataContext.AnalyzeSingleFunctionCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                          CommandParameter="{Binding}"
                                          Width="28" Height="28" Padding="4">
                                        <materialDesign:PackIcon Kind="Magnify" Width="16" Height="16"/>
                                    </Button>
                                    <Button Style="{StaticResource MaterialDesignIconButton}" 
                                          ToolTip="Generate Test Cases"
                                          Command="{Binding DataContext.GenerateTestCasesForFunctionCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                          CommandParameter="{Binding}"
                                          Width="28" Height="28" Padding="4">
                                        <materialDesign:PackIcon Kind="TestTube" Width="16" Height="16"/>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
                
                <!-- Row Style -->
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow" BasedOn="{StaticResource {x:Type DataGridRow}}">
                        <Setter Property="MinHeight" Value="44"/>
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{StaticResource AccentColorLight}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>
            </DataGrid>
        </materialDesign:Card>
    </Grid>
</UserControl>