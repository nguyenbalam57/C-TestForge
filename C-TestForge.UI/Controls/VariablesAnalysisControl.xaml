<UserControl x:Class="C_TestForge.UI.Controls.VariablesAnalysisControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    
    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <materialDesign:Card Grid.Row="0" Margin="0,0,0,12" UniformCornerRadius="8"
                           materialDesign:ShadowAssist.ShadowDepth="Depth1">
            <Grid Margin="20,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Variable" 
                                           Foreground="{StaticResource AccentColor}" 
                                           VerticalAlignment="Center" Margin="0,0,12,0" Width="24" Height="24"/>
                    <StackPanel>
                        <TextBlock Text="Variables Analysis" Style="{StaticResource HeadingStyle}" Margin="0,0,0,4"/>
                        <TextBlock Text="{Binding Variables.Count, StringFormat='Total: {0} variables found'}" 
                                 Style="{StaticResource SubheadingStyle}"/>
                    </StackPanel>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="Export Variables" Style="{StaticResource OutlinedButtonStyle}"
                          Command="{Binding ExportVariablesCommand}" 
                          Margin="0,0,8,0">
                        <Button.ContentTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Download" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding}"/>
                                </StackPanel>
                            </DataTemplate>
                        </Button.ContentTemplate>
                    </Button>
                    <Button Content="Analyze Constraints" Style="{StaticResource PrimaryButtonStyle}"
                          Command="{Binding AnalyzeVariableConstraintsCommand}">
                        <Button.ContentTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="SearchWeb" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding}"/>
                                </StackPanel>
                            </DataTemplate>
                        </Button.ContentTemplate>
                    </Button>
                </StackPanel>
            </Grid>
        </materialDesign:Card>
        
        <!-- Filters -->
        <materialDesign:Card Grid.Row="1" Margin="0,0,0,12" UniformCornerRadius="8"
                           materialDesign:ShadowAssist.ShadowDepth="Depth1">
            <Grid Margin="16,12">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Search Row -->
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBox Grid.Column="0" 
                           Style="{StaticResource MaterialDesignOutlinedTextBox}"
                           materialDesign:HintAssist.Hint="Search variables by name, type, or scope..."
                           Text="{Binding VariableSearchText, UpdateSourceTrigger=PropertyChanged}"
                           Margin="0,0,12,0"/>
                    
                    <ComboBox Grid.Column="1" Width="150"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Filter by Scope"
                            ItemsSource="{Binding AvailableScopes}"
                            SelectedItem="{Binding SelectedScopeFilter}"
                            Margin="0,0,12,0"/>
                    
                    <ComboBox Grid.Column="2" Width="150"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Filter by Type"
                            ItemsSource="{Binding AvailableTypes}"
                            SelectedItem="{Binding SelectedTypeFilter}"/>
                </Grid>
                
                <!-- Filter Toggles Row -->
                <StackPanel Grid.Row="1" Orientation="Horizontal">
                    <ToggleButton Content="Const Only" 
                                Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                                IsChecked="{Binding ShowConstOnly}"
                                Margin="0,0,8,0" Padding="8,4"/>
                    
                    <ToggleButton Content="Arrays Only" 
                                Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                                IsChecked="{Binding ShowArraysOnly}"
                                Margin="0,0,8,0" Padding="8,4"/>
                    
                    <ToggleButton Content="Pointers Only" 
                                Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                                IsChecked="{Binding ShowPointersOnly}"
                                Margin="0,0,8,0" Padding="8,4"/>
                    
                    <ToggleButton Content="With Default Values" 
                                Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                                IsChecked="{Binding ShowWithDefaultValues}"
                                Margin="0,0,8,0" Padding="8,4"/>
                    
                    <Button Content="Clear All" 
                          Style="{StaticResource TextButtonStyle}"
                          Command="{Binding ClearVariableFiltersCommand}"/>
                </StackPanel>
            </Grid>
        </materialDesign:Card>
        
        <!-- Variables DataGrid -->
        <materialDesign:Card Grid.Row="2" UniformCornerRadius="8"
                           materialDesign:ShadowAssist.ShadowDepth="Depth1">
            <DataGrid ItemsSource="{Binding FilteredVariables}" 
                    Style="{StaticResource ModernDataGridStyle}"
                    materialDesign:DataGridAssist.ColumnHeaderPadding="8,4" 
                    Margin="8" CanUserAddRows="False" CanUserDeleteRows="False"
                    SelectedItem="{Binding SelectedVariable}">
                <DataGrid.Columns>
                    <!-- Name with Type Icon -->
                    <DataGridTemplateColumn Header="Name" Width="180" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="{Binding Scope, Converter={StaticResource ScopeToIconConverter}}" 
                                                           Width="16" Height="16" Margin="0,0,6,0" VerticalAlignment="Center"
                                                           Foreground="{Binding Scope, Converter={StaticResource ScopeToColorConverter}}"/>
                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center" FontWeight="Medium"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Type Information -->
                    <DataGridTemplateColumn Header="Type" Width="140" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <TextBlock Text="{Binding TypeName}" FontWeight="Medium"/>
                                    <TextBlock Text="{Binding OriginalTypeName}" FontSize="10" 
                                             Foreground="{StaticResource SecondaryText}"
                                             Visibility="{Binding OriginalTypeName, Converter={StaticResource NullToVisibilityConverter}}"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Scope with Color -->
                    <DataGridTemplateColumn Header="Scope" Width="100" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border Background="{Binding Scope, Converter={StaticResource ScopeToColorConverter}}" 
                                      CornerRadius="12" Padding="6,2" HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding Scope}" 
                                             Foreground="White" FontSize="10" FontWeight="Medium"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Default Value -->
                    <DataGridTemplateColumn Header="Default Value" Width="*" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding DefaultValue}" 
                                         FontFamily="{StaticResource CodeFont}"
                                         TextTrimming="CharacterEllipsis"
                                         ToolTip="{Binding DefaultValue}"
                                         VerticalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Properties -->
                    <DataGridTemplateColumn Header="Properties" Width="120" 
                                          materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Border Background="{StaticResource InfoColor}" CornerRadius="8" Padding="4,2" Margin="0,0,2,0"
                                          Visibility="{Binding IsConst, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock Text="const" Foreground="White" FontSize="9"/>
                                    </Border>
                                    <Border Background="{StaticResource WarningColor}" CornerRadius="8" Padding="4,2" Margin="0,0,2,0"
                                          Visibility="{Binding IsArray, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock Text="array" Foreground="White" FontSize="9"/>
                                    </Border>
                                    <Border Background="{StaticResource AccentColor}" CornerRadius="8" Padding="4,2"
                                          Visibility="{Binding IsPointer, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock Text="ptr" Foreground="White" FontSize="9"/>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Line Number -->
                    <DataGridTextColumn Header="Line" Binding="{Binding LineNumber}" Width="60"
                                      materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Center"/>
                                <Setter Property="FontFamily" Value="{StaticResource CodeFont}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    
                    <!-- Source File -->
                    <DataGridTextColumn Header="Source File" Binding="{Binding SourceFile}" Width="150"
                                      materialDesign:DataGridAssist.ColumnHeaderPadding="8,4">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                <Setter Property="ToolTip" Value="{Binding SourceFile}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                </DataGrid.Columns>
                
                <!-- Row Style -->
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow" BasedOn="{StaticResource {x:Type DataGridRow}}">
                        <Setter Property="Height" Value="44"/>
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{StaticResource AccentColorLight}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>
            </DataGrid>
        </materialDesign:Card>
    </Grid>
</UserControl>